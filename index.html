<!DOCTYPE html>
<html lang="en-GB">
	<!-- this is terrible -->

	<head>
		<meta charset="utf-8" />

		<title>Route-plotter companion tool</title>

		<style>
body {
	font-family: sans-serif;
}

h1, p {
	grid-column: 1 / span 2;
	text-align: center;
	width: auto;
}

h1 {
	font-size: 1.5rem;
	margin: 0px;
}

main {
	margin: 100px auto;
	max-width: 400px;
}

div:last-child {
	margin-top: 8px;
	display: grid;
	grid-template-columns: auto max-content;
	gap: 8px;
	align-items: start;
}

textarea {
	resize: none;
	height: 20rem;
}
		</style>
	</head>

	<body>
		<main>
			<h1>Route-plotter companion tool</h1>
			<p>
				Converts between StatSim/GeoJSON and the
				<a href="https://github.com/19wintersp/route-plotter">route-plotter</a>
				"coords" string format.
			</p>
			<p>
				Copy the flight ID from StatSim (in the URL&mdash;not the CID) into the
				input box and press "Search ID".
			</p>

			<div>
				<div>
					<input id="opt-in-time" type="checkbox" />
					<label for="opt-in-time">Include times</label>
					<br />

					<input id="opt-in-alt" type="checkbox" />
					<label for="opt-in-alt">Include altitudes</label>
					<br />

					<input id="opt-in-spd" type="checkbox" />
					<label for="opt-in-spd">Include groud speeds</label>
					<br />

					<input id="opt-in-hdg" type="checkbox" />
					<label for="opt-in-hdg">Include headings</label>
				</div>
				<span></span>

				<input id="ss-in-fid" type="text" placeholder="18629392" />
				<button id="ss-go-fid">Search ID</button>

				<textarea id="rs-coords" readonly></textarea>
				<button id="rs-coords-copy">Copy string</button>

				<textarea id="rs-geojson" readonly></textarea>
				<button id="rs-geojson-copy">Copy GeoJSON</button>
			</div>
		</main>

		<script>
const resCoords = document.getElementById("rs-coords");
const resJson = document.getElementById("rs-geojson");

const decomp = (ord) =>
	[-1, 0, 1, 2].map((i) => Math.floor(Math.pow(60, i) * Math.abs(ord)) % 60);

const go = async (id) => {
	const res = fetch(`https://statsim.net/flights/flight/?flightid=${id}&json=true`)
		.then((res) => res.ok ? res.json() : null)
		.catch((err) => resCoords.value = resJson.value = err);

	resCoords.value = resJson.value = "Waiting for StatSim...";

	const json = await res;
	if (!json) {
		resCoords.value = resJson.value = "No results";
		return;
	}

	const { flight, points } = json;

	resCoords.value = `.plot coords ${flight.callsign} ` + points
		.map(({ latitude, longitude, ...data }) => {
			const [ya, ...yr] = decomp(latitude);
			const [xa, ...xr] = decomp(longitude);
			const pos = [
				(Math.abs(ya) << 2) | (latitude  < 0 ? 0b0010 : 0) |
				(Math.abs(xa) << 4) | (longitude < 0 ? 0b1000 : 0),
				...yr, ...xr,
			]
				.map((i) => "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[i])
				.join("");

			const label = [];
			if (document.getElementById("opt-in-time").checked) {
				const date = new Date(data.time * 1000);
				label.push(
					date.getHours().toString().padStart(2, "0") +
					date.getMinutes().toString().padStart(2, "0") +
					"Z"
				);
			}
			if (document.getElementById("opt-in-alt").checked)
				label.push(Math.floor(data.altitude / 100).toString().padStart(3, "0"));
			if (document.getElementById("opt-in-spd").checked)
				label.push("G" + Math.floor(data.speed).toString().padStart(3, "0"));
			if (document.getElementById("opt-in-hdg").checked)
				label.push("H" + Math.floor(data.heading).toString().padStart(3, "0"));

			return pos + (label.length ? `(${label.join(" ")})` : "");
		})
		.join("");

	resJson.value = JSON.stringify({
		type: "LineString",
		coordinates: points.map(({ latitude, longitude, altitude }) =>
			[longitude, latitude, altitude * 0.3048]),
	});
};

document
	.getElementById("ss-go-fid")
	.addEventListener("click", () => go(document.getElementById("ss-in-fid").value));

document
	.getElementById("rs-coords-copy")
	.addEventListener("click", () => navigator.clipboard.writeText(resCoords.value));

document
	.getElementById("rs-geojson-copy")
	.addEventListener("click", () => navigator.clipboard.writeText(resJson.value));
		</script>
	</body>
</html>
